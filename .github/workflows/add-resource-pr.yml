name: Add Resource PR
on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  build-pr:
    if: contains(github.event.issue.labels.*.name, 'new resource')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse issue and update JSON
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const body = context.payload.issue.body || '';

            function getField(label) {
              const re = new RegExp(`\n\s*${label}\s*\n+([^\n][\s\S]*?)(?=\n\s*\n|\n\s*###|$)`, 'i');
              const m = body.match(re);
              return m ? m[1].trim() : '';
            }

            const title = getField('Title');
            const url = getField('URL');
            const category = getField('Category');
            const description = getField('Description');
            const tagsLine = getField('Tags (comma-separated)') || getField('Tags');
            const tags = tagsLine ? tagsLine.split(',').map(s=>s.trim()).filter(Boolean) : [];

            if (!title || !url || !category) {
              core.setFailed('Missing required fields (title, url, category).');
              return;
            }

            // basic URL sanity
            try { new URL(url); } catch (e) { core.setFailed('Invalid URL.'); return; }

            const dataPath = path.join(process.env.GITHUB_WORKSPACE, 'data', 'resources.json');
            let items = [];
            if (fs.existsSync(dataPath)) {
              items = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
            }

            // Prevent duplicates by URL
            if (items.some(it => (it.url || '').toLowerCase() === url.toLowerCase())) {
              core.warning('Duplicate URL detected; skipping append.');
              core.setOutput('skipped', 'true');
            } else {
              items.push({ title, url, category, description, tags });
              // sort by title
              items.sort((a,b)=>a.title.localeCompare(b.title));
              fs.writeFileSync(dataPath, JSON.stringify(items, null, 2)+'\n');
              core.setOutput('skipped', 'false');
            }

            // Create a safe branch/slug
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
            core.setOutput('branch', `add-resource-${{slug}}`);

      - name: Create Pull Request
        if: steps.parse.outputs.skipped != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.parse.outputs.branch }}
          commit-message: "Add resource: ${{ github.event.issue.title || 'New resource' }}"
          title: "Add resource: ${{ github.event.issue.title || 'New resource' }}"
          body: |
            This PR was auto-generated from issue #${{ github.event.issue.number }}.
            - Title: parsed from issue form
            - Created by: @${{ github.actor }}
          labels: |
            data
          add-paths: |
            data/resources.json
